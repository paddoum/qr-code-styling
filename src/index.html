<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Styling</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .config-container {
      flex: 1;
      overflow-y: auto;
      max-height: 100vh;
    }

    .preview-container {
      flex: 1;
      position: sticky;
      top: 20px;
      text-align: center;
    }

    .form-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .form-section h3 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    input[type="color"] {
      height: 40px;
    }

    input[type="checkbox"] {
      width: auto;
      margin-right: 5px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
    }

    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }

    textarea {
      height: 100px;
      font-family: monospace;
    }

    .custom-file-upload {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    .custom-file-upload input[type="file"] {
      display: none;
    }

    .custom-file-upload button {
      background-color: #4CAF50;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    #fileName {
      color: #666;
    }
  </style>
</head>
<body>
  <div class="config-container">
    <h1>QR Code Configuration</h1>

    <div class="form-section">
      <h3>Basic Options</h3>
      <div class="form-group">
        <label for="data">QR Code Content:</label>
        <textarea id="data">https://ar-go.co</textarea>
      </div>

      <div class="form-group">
        <label for="width">Width:</label>
        <input type="number" id="width" value="300" min="100" max="1000">
      </div>

      <div class="form-group">
        <label for="height">Height:</label>
        <input type="number" id="height" value="300" min="100" max="1000">
      </div>

      <div class="form-group">
        <label for="margin">Margin:</label>
        <input type="number" id="margin" value="10" min="0" max="100">
      </div>
    </div>

    <div class="form-section">
      <h3>Dots Options</h3>
      <div class="form-group">
        <label for="dotsType">Dots Type:</label>
        <select id="dotsType">
          <option value="square">Square</option>
          <option value="dots" selected>Dots</option>
          <option value="rounded">Rounded</option>
          <option value="classy">Classy</option>
          <option value="classy-rounded">Classy Rounded</option>
          <option value="extra-rounded">Extra Rounded</option>
        </select>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="useDotsGradient"> Use Gradient
        </label>
      </div>

      <div id="dotsSolidColor">
        <div class="form-group">
          <label for="dotsColor">Color:</label>
          <input type="color" id="dotsColor" value="#000000">
        </div>
      </div>

      <div id="dotsGradientColors" style="display: none;">
        <div class="form-group">
          <label for="dotsGradientType">Gradient Type:</label>
          <select id="dotsGradientType">
            <option value="linear">Linear</option>
            <option value="radial">Radial</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dotsGradientColor1">Color 1:</label>
          <input type="color" id="dotsGradientColor1" value="#000000">
        </div>
        <div class="form-group">
          <label for="dotsGradientColor2">Color 2:</label>
          <input type="color" id="dotsGradientColor2" value="#4267B2">
        </div>
        <div class="form-group">
          <label for="dotsGradientRotation">Rotation (0-360):</label>
          <input type="number" id="dotsGradientRotation" value="0" min="0" max="360">
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3>Background Options</h3>
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="useBackgroundGradient"> Use Gradient
        </label>
      </div>

      <div id="backgroundSolidColor">
        <div class="form-group">
          <label for="backgroundColor">Color:</label>
          <input type="color" id="backgroundColor" value="#ffffff">
        </div>
      </div>

      <div id="backgroundGradientColors" style="display: none;">
        <div class="form-group">
          <label for="backgroundGradientType">Gradient Type:</label>
          <select id="backgroundGradientType">
            <option value="linear">Linear</option>
            <option value="radial">Radial</option>
          </select>
        </div>
        <div class="form-group">
          <label for="backgroundGradientColor1">Color 1:</label>
          <input type="color" id="backgroundGradientColor1" value="#ffffff">
        </div>
        <div class="form-group">
          <label for="backgroundGradientColor2">Color 2:</label>
          <input type="color" id="backgroundGradientColor2" value="#e9ebee">
        </div>
        <div class="form-group">
          <label for="backgroundGradientRotation">Rotation (0-360):</label>
          <input type="number" id="backgroundGradientRotation" value="0" min="0" max="360">
        </div>
      </div>
    </div>

    

    <div class="form-section">
      <h3>Image Options</h3>
      <div class="form-group">
        <label for="imageUrl">Image URL:</label>
        <input type="text" id="imageUrl" placeholder="https://example.com/logo.png">
      </div>
      <div class="form-group">
        <label>OR Upload Local Image:</label>
        <div class="custom-file-upload">
          <input type="file" id="imageFile" accept="image/*">
          <button type="button" id="customFileButton">Choose File</button>
          <span id="fileName">No file chosen</span>
        </div>
      </div>
      <div class="form-group">
        <label for="useProxy">
          <input type="checkbox" id="useProxy"> Use CORS proxy if direct image loading fails
        </label>
      </div>
      <div class="form-group">
        <label for="imageMargin">Margin:</label>
        <input type="number" id="imageMargin" value="5" min="0" max="50">
      </div>
      <div class="form-group">
        <label for="imageSize">Size (0.0-1.0):</label>
        <input type="number" id="imageSize" value="0.4" min="0.0" max="1.0" step="0.1">
      </div>
    </div>

    <div class="form-section">
      <h3>Error Correction Level</h3>
      <div class="form-group">
        <label for="errorCorrectionLevel">Level:</label>
        <select id="errorCorrectionLevel">
          <option value="L">L - Low (7%)</option>
          <option value="M">M - Medium (15%)</option>
          <option value="Q" selected>Q - Quartile (25%)</option>
          <option value="H">H - High (30%)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="preview-container">
    <h2>QR Code Preview</h2>

    <div id="canvas"></div>

    <div class="preview-controls" style="margin-top: 20px;">
      <button id="updateQr">Update QR Code</button>
      <button id="downloadQr">Download QR Code</button>
    </div>
  </div>

  <script src="https://unpkg.com/qr-code-styling@1.9.1/lib/qr-code-styling.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set up toggle for gradient options
      document.getElementById('useDotsGradient').addEventListener('change', function() {
        document.getElementById('dotsSolidColor').style.display = this.checked ? 'none' : 'block';
        document.getElementById('dotsGradientColors').style.display = this.checked ? 'block' : 'none';
      });

      // Set up toggle for background options with gradient support
      document.getElementById('useBackgroundGradient').addEventListener('change', function() {
        document.getElementById('backgroundSolidColor').style.display = this.checked ? 'none' : 'block';
        document.getElementById('backgroundGradientColors').style.display = this.checked ? 'block' : 'none';
      });

      // Handle custom file button
      document.getElementById('customFileButton').addEventListener('click', function() {
        document.getElementById('imageFile').click();
      });

      // Handle file uploads
      document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Clear the URL input when using file upload
          document.getElementById('imageUrl').value = '';

          // Update the file name display
          document.getElementById('fileName').textContent = file.name;

          const reader = new FileReader();
          reader.onload = function(event) {
            // Store the data URL in a data attribute for later use
            document.getElementById('imageFile').dataset.imageData = event.target.result;
            // Automatically update QR code with the new image
            document.getElementById('updateQr').click();
          };
          reader.readAsDataURL(file);
        }
      });

      // Initial QR code
      const qrCode = new QRCodeStyling({
        width: 300,
        height: 300,
        type: "svg",
        data: "https://replit.com",
        margin: 10,
        qrOptions: {
          typeNumber: 0,
          mode: "Byte",
          errorCorrectionLevel: "Q"
        },
        dotsOptions: {
          type: "dots",
          color: "#000000"
        },
        backgroundOptions: {
          color: "#ffffff",
        },
        cornersSquareOptions: {
          type: "square",
          color: "#000000"
        },
        cornersDotOptions: {
          type: "square",
          color: "#000000"
        }
      });

      // Display the QR code
      qrCode.append(document.getElementById("canvas"));

      // Event handlers
      document.getElementById('updateQr').addEventListener('click', function() {
        // Get all parameters from form
        const data = document.getElementById('data').value;
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        const margin = parseInt(document.getElementById('margin').value);
        const dotsType = document.getElementById('dotsType').value;
        const dotsColor = document.getElementById('dotsColor').value;
        const backgroundColor = document.getElementById('backgroundColor').value;
        // Default values for corners instead of getting from UI
        const cornersSquareType = "square";
        const cornersSquareColor = "#000000";
        const cornersDotType = "square";
        const cornersDotColor = "#000000";
        const imageUrl = document.getElementById('imageUrl').value;
        const imageMargin = parseInt(document.getElementById('imageMargin').value);
        const imageSize = parseFloat(document.getElementById('imageSize').value);
        const errorCorrectionLevel = document.getElementById('errorCorrectionLevel').value;

        // Create options object
        const options = {
          width,
          height,
          type: "svg",
          data,
          margin,
          qrOptions: {
            typeNumber: 0,
            mode: "Byte",
            errorCorrectionLevel
          },
          cornersSquareOptions: {
            type: cornersSquareType,
            color: cornersSquareColor
          },
          cornersDotOptions: {
            type: cornersDotType,
            color: cornersDotColor
          }
        };

        // Handle dots options with gradient support
        if (document.getElementById('useDotsGradient').checked) {
          const gradientType = document.getElementById('dotsGradientType').value;
          const color1 = document.getElementById('dotsGradientColor1').value;
          const color2 = document.getElementById('dotsGradientColor2').value;
          const rotation = parseInt(document.getElementById('dotsGradientRotation').value);

          options.dotsOptions = {
            type: dotsType,
            gradient: {
              type: gradientType,
              rotation,
              colorStops: [
                { offset: 0, color: color1 },
                { offset: 1, color: color2 }
              ]
            }
          };
        } else {
          options.dotsOptions = {
            type: dotsType,
            color: dotsColor
          };
        }

        // Handle background options with gradient support
        if (document.getElementById('useBackgroundGradient').checked) {
          const gradientType = document.getElementById('backgroundGradientType').value;
          const color1 = document.getElementById('backgroundGradientColor1').value;
          const color2 = document.getElementById('backgroundGradientColor2').value;
          const rotation = parseInt(document.getElementById('backgroundGradientRotation').value);

          options.backgroundOptions = {
            gradient: {
              type: gradientType,
              rotation,
              colorStops: [
                { offset: 0, color: color1 },
                { offset: 1, color: color2 }
              ]
            }
          };
        } else {
          options.backgroundOptions = {
            color: backgroundColor
          };
        }

        // Function to convert URL to data URI
        const urlToDataURI = (url) => {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';

            img.onload = function() {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);

              const dataURI = canvas.toDataURL('image/png');
              resolve(dataURI);
            };

            img.onerror = function() {
              reject(new Error('Failed to load image'));
            };

            // Use CORS proxy if checkbox is checked
            const useProxy = document.getElementById('useProxy').checked;
            img.src = useProxy ? `https://cors-anywhere.herokuapp.com/${url}` : url;
          });
        };

        // Get uploaded file data if available
        const fileInput = document.getElementById('imageFile');
        const uploadedImageData = fileInput.dataset.imageData;

        // Add image options if URL is provided or file is uploaded
        if ((imageUrl && imageUrl.trim() !== '') || uploadedImageData) {
          // Show loading indicator in place of QR
          const canvas = document.getElementById("canvas");
          canvas.innerHTML = "<div style='text-align:center;padding:20px;'>Processing image...</div>";

          // If we have an uploaded file, use it directly
          if (uploadedImageData) {
            // Use the data URI from the uploaded file
            options.image = uploadedImageData;
            options.imageOptions = {
              margin: imageMargin,
              imageSize: imageSize,
              hideBackgroundDots: true
            };

            console.log("Using uploaded image");

            // Create and display QR code with data URI
            const newQrCode = new QRCodeStyling(options);
            canvas.innerHTML = "";
            newQrCode.append(canvas);

            // Store for download button
            window.currentQrCode = newQrCode;

            // Return early to prevent creating QR without image
            return;
          }

          // Otherwise, convert URL to data URI
          if (imageUrl && imageUrl.trim() !== '') {
            urlToDataURI(imageUrl)
              .then(dataURI => {
                // Now use the data URI instead of URL
                options.image = dataURI;
                options.imageOptions = {
                  margin: imageMargin,
                  imageSize: imageSize,
                  hideBackgroundDots: true
                };

                console.log("Using image as data URI");

                // Create and display QR code with data URI
                const newQrCode = new QRCodeStyling(options);
                canvas.innerHTML = "";
                newQrCode.append(canvas);

                // Store for download button
                window.currentQrCode = newQrCode;
              })
              .catch(error => {
                console.error("Error converting image:", error);
                canvas.innerHTML = "<div style='color:red;text-align:center;padding:20px;'>Failed to load image. Check URL and try again.</div>";
              });

            // Return early to prevent creating QR without image
            return;
          }
        }


        // Create new QR code with updated options
        const newQrCode = new QRCodeStyling(options);

        // Clear previous and append new
        const canvas = document.getElementById("canvas");
        canvas.innerHTML = "";
        newQrCode.append(canvas);

        // Store for download button
        window.currentQrCode = newQrCode;
      });

      document.getElementById('downloadQr').addEventListener('click', function() {
        const qr = window.currentQrCode || qrCode;
        qr.download({
          extension: "svg",
          name: "qr-code"
        });
      });

      // Store for download button
      window.currentQrCode = qrCode;
    });
  </script>
</body>
</html>